{% extends "base.html" %}
{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤{% endblock %}
{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h2>
      <div class="text-secondary">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
    </div>
    <div class="col-auto">
        <div class="btn-group monitor-controls" role="group">
        <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-all">
          <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
        </button>
      </div>
    </div>
  </div>
  <div class="hr-text"></div>
</div>


<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <div class="stat-icon mb-2">
          <i class="fas fa-microchip text-primary"></i>
        </div>
        <div class="stat-value" id="cpu-stat">‚Äî</div>
        <div class="stat-label">–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</div>
        <div class="stat-trend" id="cpu-trend"></div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <div class="stat-icon mb-2">
          <i class="fas fa-memory text-success"></i>
        </div>
        <div class="stat-value" id="memory-stat">‚Äî</div>
        <div class="stat-label">–ü–∞–º—è—Ç—å</div>
        <div class="stat-trend" id="memory-trend"></div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <div class="stat-icon mb-2">
          <i class="fas fa-hdd text-warning"></i>
        </div>
        <div class="stat-value" id="disk-stat">‚Äî</div>
        <div class="stat-label">–î–∏—Å–∫</div>
        <div class="stat-trend" id="disk-trend"></div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card stat-card">
      <div class="card-body text-center">
        <div class="stat-icon mb-2">
          <i class="fas fa-network-wired text-info"></i>
        </div>
        <div class="stat-value" id="network-stat">‚Äî</div>
        <div class="stat-label">–°–µ—Ç—å</div>
        <div class="stat-trend" id="network-trend"></div>
      </div>
    </div>
  </div>
</div>


<div class="row g-3">
  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          <i class="fas fa-chart-line text-primary me-2"></i>
          –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        </h3>
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="chart-period" id="period-1h" value="1" checked>
          <label class="btn btn-outline-primary" for="period-1h">1—á</label>
          <input type="radio" class="btn-check" name="chart-period" id="period-6h" value="6">
          <label class="btn btn-outline-primary" for="period-6h">6—á</label>
          <input type="radio" class="btn-check" name="chart-period" id="period-24h" value="24">
          <label class="btn btn-outline-primary" for="period-24h">24—á</label>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="main-chart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title mb-0" id="local-panel-header">
          <i class="fas fa-server text-success me-2"></i>
          –¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä
        </h3>
      </div>
      <div class="card-body">
        <div id="local-metrics" class="monitor-details">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <div class="mt-3">
          <canvas id="local-mini-chart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-3 mt-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          <i class="fas fa-server text-info me-2"></i>
          –°–µ—Ä–≤–µ—Ä—ã (xui_hosts)
        </h3>
        <span class="badge bg-primary" id="hosts-count">{{ hosts|length }}</span>
      </div>
      <div class="card-body">
        {% if hosts %}
          <div class="servers-list">
          {% for h in hosts %}
            <div class="server-item" data-host="{{ h.host_name }}">
              <div class="server-header">
                <div class="server-info">
                  <div class="server-name">
                    <i class="fas fa-server me-2"></i>
                    {{ h.host_name }}
                  </div>
                  <div class="server-url text-muted small">{{ h.host_url or 'URL –Ω–µ —É–∫–∞–∑–∞–Ω' }}</div>
                </div>
                <div class="server-status">
                  <div class="status-indicator" id="host-status-{{ loop.index }}"></div>
                  <button class="btn btn-outline-primary btn-sm server-item" data-host="{{ h.host_name }}" data-target="#host-{{ loop.index }}">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
              <div class="server-metrics" id="host-{{ loop.index }}">
                <div class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
              </div>
            </div>
          {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-server text-muted mb-3"></i>
            <p class="text-muted">–•–æ—Å—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
          </div>
        {% endif %}
    </div>
  </div>
</div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          <i class="fas fa-terminal text-warning me-2"></i>
          SSH-—Ü–µ–ª–∏
        </h3>
        <span class="badge bg-warning" id="targets-count">{{ ssh_targets|length }}</span>
      </div>
      <div class="card-body">
        {% if ssh_targets %}
          <div class="servers-list">
          {% for t in ssh_targets %}
            <div class="server-item" data-target="{{ t.target_name }}">
              <div class="server-header">
                <div class="server-info">
                  <div class="server-name">
                    <i class="fas fa-terminal me-2"></i>
                    {{ t.target_name }}
                  </div>
                  <div class="server-url text-muted small">{{ t.ssh_host }}:{{ t.ssh_port or 22 }}</div>
                </div>
                <div class="server-status">
                  <div class="status-indicator" id="target-status-{{ loop.index }}"></div>
                  <button class="btn btn-outline-warning btn-sm ssh-target" data-target-name="{{ t.target_name }}" data-target="#target-{{ loop.index }}">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
              <div class="server-metrics" id="target-{{ loop.index }}">
                <div class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
              </div>
            </div>
          {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-terminal text-muted mb-3"></i>
            <p class="text-muted">SSH-—Ü–µ–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
(function(){
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let mainChart = null;
  let localMiniChart = null;
  let autoRefreshInterval = null;
  let isAutoRefresh = false;
  let currentPeriod = 1; // —á–∞—Å—ã
  
  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏
  let lastNetworkData = null;
  let lastNetworkTime = null;
  
  // –ö–ª—é—á–∏ –¥–ª—è localStorage
  const NETWORK_DATA_KEY = 'monitor_network_data';
  const NETWORK_TIME_KEY = 'monitor_network_time';

  // –£—Ç–∏–ª–∏—Ç—ã
  async function fetchJSON(url){
    try {
      const resp = await fetch(url, { credentials: 'same-origin' });
      return await resp.json();
    } catch(e){ 
      return { ok: false, error: String(e) };
    }
  }

  function fmtBytes(n){ 
    if(n==null) return '‚Äî';
    const units=['B','KB','MB','GB','TB']; 
    let i=0, x=Number(n); 
    while(x>=1024 && i<units.length-1){ x/=1024; i++; }
    return x.toFixed(1)+' '+units[i];
  }

  function fmtPct(x){ 
    return (x==null)?'‚Äî':(Number(x).toFixed(1)+'%'); 
  }

  function secsToDHMS(s){ 
    if(!s&&s!==0) return '‚Äî'; 
    s=Number(s);
    const d=Math.floor(s/86400); s%=86400; 
    const h=Math.floor(s/3600); s%=3600; 
    const m=Math.floor(s/60); 
    const sec=s%60;
    const parts=[]; 
    if(d) parts.push(d+'–¥'); 
    if(h) parts.push(h+'—á'); 
    if(m) parts.push(m+'–º'); 
    if(sec && parts.length===0) parts.push(sec+'—Å');
    return parts.join(' ');
  }

  function getStatusColor(value, thresholds = { warning: 70, critical: 90 }) {
    if (value == null) return 'text-muted';
    if (value >= thresholds.critical) return 'text-danger';
    if (value >= thresholds.warning) return 'text-warning';
    return 'text-success';
  }

  function getStatusIndicator(value, thresholds = { warning: 70, critical: 90 }) {
    if (value == null) return 'bg-secondary';
    if (value >= thresholds.critical) return 'bg-danger pulse';
    if (value >= thresholds.warning) return 'bg-warning';
    return 'bg-success';
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏
  function calculateNetworkSpeed(currentData, sourceId = 'default') {
    const now = Date.now();
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log(`calculateNetworkSpeed –¥–ª—è ${sourceId}:`, {
      currentData: currentData,
      bytes_sent: currentData.bytes_sent,
      bytes_recv: currentData.bytes_recv
    });
    
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    const dataKey = `${NETWORK_DATA_KEY}_${sourceId}`;
    const timeKey = `${NETWORK_TIME_KEY}_${sourceId}`;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
    try {
      const savedData = localStorage.getItem(dataKey);
      const savedTime = localStorage.getItem(timeKey);
      
      if (savedData && savedTime) {
        lastNetworkData = JSON.parse(savedData);
        lastNetworkTime = parseInt(savedTime);
      }
    } catch (e) {
      console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–∏ –∏–∑ localStorage:', e);
    }
    
    if (!lastNetworkData || !lastNetworkTime) {
      console.log(`–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${sourceId}, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É`);
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É
      lastNetworkData = currentData;
      lastNetworkTime = now;
      
      try {
        localStorage.setItem(dataKey, JSON.stringify(currentData));
        localStorage.setItem(timeKey, now.toString());
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–∏ –≤ localStorage:', e);
      }
      
      return { upSpeed: 0, downSpeed: 0, totalSpeed: 0 };
    }
    
    const timeDiff = (now - lastNetworkTime) / 1000; // —Å–µ–∫—É–Ω–¥—ã
    if (timeDiff < 1) {
      console.log(`–í—Ä–µ–º—è –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–ª—è ${sourceId}: ${timeDiff}—Å`);
      return { upSpeed: 0, downSpeed: 0, totalSpeed: 0 };
    }
    
    const bytesUpDiff = (currentData.bytes_sent || 0) - (lastNetworkData.bytes_sent || 0);
    const bytesDownDiff = (currentData.bytes_recv || 0) - (lastNetworkData.bytes_recv || 0);
    
    const upSpeed = Math.max(0, bytesUpDiff / timeDiff);
    const downSpeed = Math.max(0, bytesDownDiff / timeDiff);
    const totalSpeed = upSpeed + downSpeed;
    
    console.log(`–°–∫–æ—Ä–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∞ –¥–ª—è ${sourceId}:`, {
      timeDiff: timeDiff,
      bytesUpDiff: bytesUpDiff,
      bytesDownDiff: bytesDownDiff,
      upSpeed: upSpeed,
      downSpeed: downSpeed,
      totalSpeed: totalSpeed
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    lastNetworkData = currentData;
    lastNetworkTime = now;
    
    try {
      localStorage.setItem(dataKey, JSON.stringify(currentData));
      localStorage.setItem(timeKey, now.toString());
    } catch (e) {
      console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–∏ –≤ localStorage:', e);
    }
    
    return { upSpeed, downSpeed, totalSpeed };
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
  function updateStatsCards(data) {
    if (!data || !data.ok) return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–µ)
    const isRemote = data.uname !== undefined; // —É–¥–∞–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–º–µ—é—Ç –ø–æ–ª–µ uname
    
    let cpu, mem, disk, net;
    
    if (isRemote) {
      // –î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      cpu = { percent: data.cpu_percent || 0, count_logical: data.cpu_count || '‚Äî' };
      mem = { 
        percent: data.memory_percent || 0, 
        used: (data.memory_used_mb || 0) * 1024 * 1024, // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ú–ë –≤ –±–∞–π—Ç—ã
        total: (data.memory_total_mb || 0) * 1024 * 1024
      };
      disk = { percent: data.disk_percent || 0, mountpoint: data.disk_mountpoint || '/' };
      net = { 
        bytes_sent: data.network_sent || 0, 
        bytes_recv: data.network_recv || 0,
        packets_sent: data.network_packets_sent || 0,
        packets_recv: data.network_packets_recv || 0
      };
    } else {
      // –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      cpu = data.cpu || {};
      mem = data.memory || {};
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –¥–∏—Å–∫–∞ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º
      // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—â–∏–π disk_percent, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –¥–∏—Å–∫
      const diskPercent = data.disk_percent !== undefined ? data.disk_percent : (data.disks?.[0]?.percent || 0);
      disk = { percent: diskPercent, mountpoint: data.disks?.[0]?.mountpoint || '/' };
      
      // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–∏—Å–∫–∞
      console.log('–î–∞–Ω–Ω—ã–µ –¥–∏—Å–∫–∞:', {
        disk_percent: data.disk_percent,
        first_disk_percent: data.disks?.[0]?.percent,
        final_disk_percent: diskPercent,
        disks: data.disks
      });
      net = data.net || {};
    }

    // –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä
    document.getElementById('cpu-stat').innerHTML = `
      <span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span>
    `;
    document.getElementById('cpu-trend').innerHTML = `
      <small class="text-muted">${cpu.count_logical || '‚Äî'} —è–¥–µ—Ä</small>
    `;

    // –ü–∞–º—è—Ç—å
    document.getElementById('memory-stat').innerHTML = `
      <span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span>
    `;
    document.getElementById('memory-trend').innerHTML = `
      <small class="text-muted">${fmtBytes(mem.used || 0)} / ${fmtBytes(mem.total || 0)}</small>
    `;

    // –î–∏—Å–∫
    document.getElementById('disk-stat').innerHTML = `
      <span class="${getStatusColor(disk.percent)}">${fmtPct(disk.percent)}</span>
    `;
    document.getElementById('disk-trend').innerHTML = `
      <small class="text-muted">${disk.mountpoint || '‚Äî'}</small>
    `;

    // –°–µ—Ç—å - –≤—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
    console.log('–î–∞–Ω–Ω—ã–µ —Å–µ—Ç–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫:', {
      isRemote: isRemote,
      net: net,
      rawData: data
    });
    
    // –î–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    // –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞, –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
    let networkSpeed;
    if (window.lastCalculatedNetworkSpeed && window.lastCalculatedNetworkSpeed.sourceId !== 'stats_cards') {
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫');
      networkSpeed = window.lastCalculatedNetworkSpeed.speed;
    } else {
      networkSpeed = calculateNetworkSpeed(net, 'stats_cards');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    window.lastCalculatedNetworkSpeed = {
      sourceId: 'stats_cards',
      speed: networkSpeed,
      timestamp: Date.now()
    };
    const netUp = fmtBytes(net.bytes_sent || 0);
    const netDown = fmtBytes(net.bytes_recv || 0);
    const netPackets = (net.packets_sent || 0) + (net.packets_recv || 0);
    const netTotal = (net.bytes_sent || 0) + (net.bytes_recv || 0);
    const netTotalFormatted = fmtBytes(netTotal);
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('–°–µ—Ç–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–∞—Ä—Ç–æ—á–∫–∏):', {
      source: 'stats_cards',
      bytes_sent: net.bytes_sent,
      bytes_recv: net.bytes_recv,
      packets_sent: net.packets_sent,
      packets_recv: net.packets_recv,
      speed: networkSpeed,
      speedUp: fmtBytes(networkSpeed.upSpeed),
      speedDown: fmtBytes(networkSpeed.downSpeed),
      speedTotal: fmtBytes(networkSpeed.totalSpeed)
    });
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
    const speedUp = fmtBytes(networkSpeed.upSpeed) + '/—Å';
    const speedDown = fmtBytes(networkSpeed.downSpeed) + '/—Å';
    const speedTotal = fmtBytes(networkSpeed.totalSpeed) + '/—Å';
    
    document.getElementById('network-stat').innerHTML = `
      <span class="text-info">${speedTotal}</span>
    `;
    document.getElementById('network-trend').innerHTML = `
      <small class="text-muted">‚Üë${speedUp} ‚Üì${speedDown}</small>
      <br><small class="text-muted">üì¶ ${netPackets.toLocaleString()} –ø–∞–∫–µ—Ç–æ–≤</small>
    `;
  }

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
  function renderLocal(el, data){
    if(!data || !data.ok){ 
      el.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>'+(data && data.error ? data.error : '–û—à–∏–±–∫–∞')+'</div>'; 
      return; 
    }
    
    const cpu = data.cpu||{}; 
    const mem = data.memory||{}; 
    const sw = data.swap||{}; 
    const net = data.net||{};
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Å–µ—Ç–∏
    const networkSpeed = calculateNetworkSpeed(net, 'local_details');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    window.lastCalculatedNetworkSpeed = {
      sourceId: 'local_details',
      speed: networkSpeed,
      timestamp: Date.now()
    };
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    console.log('–õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–µ—Ç–∞–ª–∏):', {
      source: 'local_details',
      bytes_sent: net.bytes_sent,
      bytes_recv: net.bytes_recv,
      packets_sent: net.packets_sent,
      packets_recv: net.packets_recv,
      speed: networkSpeed
    });
    
    const disks = (data.disks||[]).map(d => `
      <div class="disk-item d-flex justify-content-between align-items-center py-1">
        <span class="text-muted small">${d.mountpoint||d.device}</span>
        <div class="d-flex align-items-center gap-2">
          <div class="progress" style="width: 60px; height: 6px;">
            <div class="progress-bar ${getStatusColor(d.percent, { warning: 80, critical: 95 }).replace('text-', 'bg-')}" 
                 style="width: ${d.percent || 0}%"></div>
          </div>
          <span class="small ${getStatusColor(d.percent)}">${fmtPct(d.percent)}</span>
        </div>
      </div>
    `).join('');

    el.innerHTML = `
      <div class="monitor-info">
        <div class="info-item">
          <i class="fas fa-server text-primary me-2"></i>
          <strong>${data.hostname||'‚Äî'}</strong>
          <span class="text-muted small">(${data.platform||''})</span>
        </div>
        <div class="info-item">
          <i class="fas fa-clock text-info me-2"></i>
          <span>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${secsToDHMS(data.uptime_sec)}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-microchip text-primary me-2"></i>
          <span>–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä: <span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span></span>
          <small class="text-muted">(${cpu.count_logical||'‚Äî'} –ª–æ–≥–∏—á, ${cpu.count_physical||'‚Äî'} —Ñ–∏–∑–∏—á)</small>
        </div>
        <div class="info-item">
          <i class="fas fa-memory text-success me-2"></i>
          <span>–ü–∞–º—è—Ç—å: <span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span></span>
          <small class="text-muted">${fmtBytes(mem.used||0)} / ${fmtBytes(mem.total||0)}</small>
        </div>
        <div class="info-item">
          <i class="fas fa-exchange-alt text-warning me-2"></i>
          <span>–°–µ—Ç—å: ‚Üë${fmtBytes(net.bytes_sent||0)} ‚Üì${fmtBytes(net.bytes_recv||0)}</span>
          <small class="text-muted">(${(net.packets_sent||0) + (net.packets_recv||0)} –ø–∞–∫–µ—Ç–æ–≤)</small>
          <br><small class="text-info">–°–∫–æ—Ä–æ—Å—Ç—å: ‚Üë${fmtBytes(networkSpeed.upSpeed)}/—Å ‚Üì${fmtBytes(networkSpeed.downSpeed)}/—Å</small>
        </div>
      </div>
      <div class="disks-section mt-3">
        <h6 class="text-muted mb-2">–î–∏—Å–∫–∏:</h6>
        ${disks}
      </div>`;
  }

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
  function renderRemote(el, data){
    if(!data || !data.ok){ 
      el.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>'+(data && data.error ? data.error : '–û—à–∏–±–∫–∞')+'</div>'; 
      return; 
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
    const cpu = { percent: data.cpu_percent || 0, count_logical: data.cpu_count || '‚Äî' };
    const mem = { 
      percent: data.memory_percent || 0, 
      used_mb: data.memory_used_mb || 0,
      total_mb: data.memory_total_mb || 0
    };
    const disk = { percent: data.disk_percent || 0, mountpoint: data.disk_mountpoint || '/' };
    const net = { 
      bytes_sent: data.network_sent || 0, 
      bytes_recv: data.network_recv || 0,
      packets_sent: data.network_packets_sent || 0,
      packets_recv: data.network_packets_recv || 0
    };
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Å–µ—Ç–∏
    const networkSpeed = calculateNetworkSpeed(net, 'remote_details');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    window.lastCalculatedNetworkSpeed = {
      sourceId: 'remote_details',
      speed: networkSpeed,
      timestamp: Date.now()
    };
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    console.log('–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–µ—Ç–∞–ª–∏):', {
      source: 'remote_details',
      bytes_sent: net.bytes_sent,
      bytes_recv: net.bytes_recv,
      packets_sent: net.packets_sent,
      packets_recv: net.packets_recv,
      speed: networkSpeed
    });
    
    const disks = `
      <div class="disk-item d-flex justify-content-between align-items-center py-1">
        <span class="text-muted small">${disk.mountpoint}</span>
        <div class="d-flex align-items-center gap-2">
          <div class="progress" style="width: 60px; height: 6px;">
            <div class="progress-bar ${getStatusColor(disk.percent, { warning: 80, critical: 95 }).replace('text-', 'bg-')}" 
                 style="width: ${disk.percent || 0}%"></div>
          </div>
          <span class="small ${getStatusColor(disk.percent)}">${fmtPct(disk.percent)}</span>
        </div>
      </div>
    `;

    el.innerHTML = `
      <div class="monitor-info">
        <div class="info-item">
          <i class="fas fa-terminal text-warning me-2"></i>
          <strong>${data.uname||'‚Äî'}</strong>
        </div>
        <div class="info-item">
          <i class="fas fa-clock text-info me-2"></i>
          <span>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${secsToDHMS(data.uptime_sec)}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-microchip text-primary me-2"></i>
          <span>–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä: <span class="${getStatusColor(cpu.percent)}">${fmtPct(cpu.percent)}</span></span>
          <small class="text-muted">(${cpu.count_logical} —è–¥–µ—Ä)</small>
        </div>
        <div class="info-item">
          <i class="fas fa-chart-line text-primary me-2"></i>
          <span>–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: ${(data.loadavg||[]).join(', ')||'‚Äî'}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-memory text-success me-2"></i>
          <span>–ü–∞–º—è—Ç—å: <span class="${getStatusColor(mem.percent)}">${fmtPct(mem.percent)}</span></span>
          <small class="text-muted">${mem.used_mb||'‚Äî'} / ${mem.total_mb||'‚Äî'} –ú–ë</small>
        </div>
        <div class="info-item">
          <i class="fas fa-exchange-alt text-warning me-2"></i>
          <span>–°–µ—Ç—å: ‚Üë${fmtBytes(net.bytes_sent||0)} ‚Üì${fmtBytes(net.bytes_recv||0)}</span>
          <small class="text-muted">(${(net.packets_sent||0) + (net.packets_recv||0)} –ø–∞–∫–µ—Ç–æ–≤)</small>
          <br><small class="text-info">–°–∫–æ—Ä–æ—Å—Ç—å: ‚Üë${fmtBytes(networkSpeed.upSpeed)}/—Å ‚Üì${fmtBytes(networkSpeed.downSpeed)}/—Å</small>
        </div>
      </div>
      <div class="disks-section mt-3">
        <h6 class="text-muted mb-2">–î–∏—Å–∫–∏:</h6>
        ${disks}
      </div>`;
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
  function createMainChart() {
    const ctx = document.getElementById('main-chart');
    if (!ctx) return null;

    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(174, 62, 201, 0.1)');
    gradient.addColorStop(1, 'rgba(174, 62, 201, 0.01)');

    mainChart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels: [], 
        datasets: [
          { 
            label: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä %', 
            data: [], 
            borderColor: '#ae3ec9', 
            backgroundColor: 'rgba(174, 62, 201, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 6
          },
          { 
            label: '–ü–∞–º—è—Ç—å %', 
            data: [], 
            borderColor: '#51cf66', 
            backgroundColor: 'rgba(81, 207, 102, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 6
          },
          { 
            label: '–î–∏—Å–∫ %', 
            data: [], 
            borderColor: '#ff922b', 
            backgroundColor: 'rgba(255, 146, 43, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: { 
          legend: { 
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 8
          }
        },
        scales: { 
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          },
          y: { 
            suggestedMin: 0, 
            suggestedMax: 100, 
            grid: {
              color: 'rgba(255, 255, 255, 0.05)'
            },
            ticks: { 
              color: 'rgba(255, 255, 255, 0.7)',
              callback: (v) => v + '%' 
            } 
          } 
        },
        animation: {
          duration: 1000,
          easing: 'easeInOutQuart'
        }
      }
    });
    return mainChart;
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞
  function createLocalMiniChart() {
    const ctx = document.getElementById('local-mini-chart');
    if (!ctx) return null;

    localMiniChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä', '–ü–∞–º—è—Ç—å', '–î–∏—Å–∫'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: [
            'rgba(174, 62, 201, 0.8)',
            'rgba(81, 207, 102, 0.8)',
            'rgba(255, 146, 43, 0.8)'
          ],
          borderColor: [
            '#ae3ec9',
            '#51cf66',
            '#ff922b'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 10
            }
          }
        },
        cutout: '60%'
      }
    });
    return localMiniChart;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
  async function refreshCharts() {
    const url = `{{ url_for('monitor_series_json', scope='local', name='panel') }}?hours=${currentPeriod}`;
    const res = await fetchJSON(url);
    
    if (!res || !res.ok) {
      return;
    }

    const items = res.items || [];
    
    if (items.length === 0) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
      if (mainChart) {
        mainChart.data.labels = ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ ' + currentPeriod + '—á'];
        mainChart.data.datasets[0].data = [0];
        mainChart.data.datasets[1].data = [0];
        mainChart.data.datasets[2].data = [0];
        mainChart.update('none');
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const chartContainer = document.querySelector('.chart-container');
      if (chartContainer) {
        let noDataMsg = chartContainer.querySelector('.no-data-message');
        if (!noDataMsg) {
          noDataMsg = document.createElement('div');
          noDataMsg.className = 'no-data-message alert alert-info text-center';
          noDataMsg.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${currentPeriod} —á–∞—Å–æ–≤.
            <br><small class="text-muted">–î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª—å—à–∏–π –ø–µ—Ä–∏–æ–¥.</small>
          `;
          chartContainer.appendChild(noDataMsg);
        }
      }
      return;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
    const noDataMsg = document.querySelector('.no-data-message');
    if (noDataMsg) {
      noDataMsg.remove();
    }
    
    const labels = items.map(i => {
      const date = new Date(i.created_at);
      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    });
    
    const cpu = items.map(i => i.cpu_percent != null ? Number(i.cpu_percent) : null);
    const mem = items.map(i => i.mem_percent != null ? Number(i.mem_percent) : null);
    const disk = items.map(i => i.disk_percent != null ? Number(i.disk_percent) : null);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
    if (mainChart) {
      mainChart.data.labels = labels;
      mainChart.data.datasets[0].data = cpu;
      mainChart.data.datasets[1].data = mem;
      mainChart.data.datasets[2].data = disk;
      mainChart.update('none');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞
    if (localMiniChart && items.length > 0) {
      const lastItem = items[items.length - 1];
      localMiniChart.data.datasets[0].data = [
        lastItem.cpu_percent || 0,
        lastItem.mem_percent || 0,
        lastItem.disk_percent || 0
      ];
      localMiniChart.update('none');
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
  async function refreshLocal() {
    const el = document.getElementById('local-metrics');
    const data = await fetchJSON("{{ url_for('monitor_local_json') }}");
    renderLocal(el, data);
    updateStatsCards(data);
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
  async function refreshLocalPanel() {
    const el = document.getElementById('local-metrics');
    
    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ —Ö–æ—Å—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
    try {
      const hostsList = JSON.parse('{{ hosts|tojson|safe }}');
      if (hostsList && hostsList.length > 0) {
        const currentHost = hostsList[0];
        const data = await fetchJSON(`{{ url_for('monitor_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(currentHost.host_name)));
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
        // console.log('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:', data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏
        const headerEl = document.querySelector('#local-panel-header');
        if (headerEl) {
          headerEl.innerHTML = `
            <i class="fas fa-server text-success me-2"></i>
            –¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä: ${currentHost.host_name}
          `;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º renderRemote –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        renderRemote(el, data);
        updateStatsCards(data);
        return;
      }
    } catch (e) {
      console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ö–æ—Å—Ç–æ–≤:', e);
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç —Ö–æ—Å—Ç–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const data = await fetchJSON("{{ url_for('monitor_local_json') }}");
    // console.log('–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
    
    const headerEl = document.querySelector('#local-panel-header');
    if (headerEl) {
      headerEl.innerHTML = `
        <i class="fas fa-desktop text-info me-2"></i>
        –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å
      `;
    }
    renderLocal(el, data);
    updateStatsCards(data);
  }

  // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
  async function bindButtons() {
    // –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–æ–≤
    document.querySelectorAll('button[data-host]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const host = btn.getAttribute('data-host');
        const targetSel = btn.getAttribute('data-target');
        const el = document.querySelector(targetSel);
        const statusEl = document.querySelector(`#host-status-${Array.from(document.querySelectorAll('button[data-host]')).indexOf(btn) + 1}`);
        
        if (el) {
          el.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }
        if (statusEl) {
          statusEl.className = 'status-indicator bg-warning';
        }

        const data = await fetchJSON(`{{ url_for('monitor_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(host)));
        
        if (el) renderRemote(el, data);
        if (statusEl) {
          statusEl.className = `status-indicator ${data.ok ? getStatusIndicator(data.cpu?.percent || 0) : 'bg-danger'}`;
        }
      });
    });

    // –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSH —Ü–µ–ª–µ–π
    document.querySelectorAll('button[data-target-name]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const name = btn.getAttribute('data-target-name');
        const targetSel = btn.getAttribute('data-target');
        const el = document.querySelector(targetSel);
        const statusEl = document.querySelector(`#target-status-${Array.from(document.querySelectorAll('button[data-target-name]')).indexOf(btn) + 1}`);
        
        if (el) {
          el.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }
        if (statusEl) {
          statusEl.className = 'status-indicator bg-warning';
        }

        const data = await fetchJSON(`{{ url_for('monitor_target_json', target_name='__T__') }}`.replace('__T__', encodeURIComponent(name)));
        
        if (el) renderRemote(el, data);
        if (statusEl) {
          statusEl.className = `status-indicator ${data.ok ? getStatusIndicator(data.cpu?.percent || 0) : 'bg-danger'}`;
        }
      });
    });

    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö
    document.getElementById('refresh-all')?.addEventListener('click', async () => {
      await refreshLocalPanel();
      await refreshCharts();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ö–æ—Å—Ç—ã –∏ —Ü–µ–ª–∏
      document.querySelectorAll('button[data-host], button[data-target-name]').forEach(btn => {
        btn.click();
      });
    });


    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ)
    autoRefreshInterval = setInterval(async () => {
      await refreshLocalPanel();
      await refreshCharts();
    }, 5000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –ø–µ—Ä–∏–æ–¥–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    document.querySelectorAll('input[name="chart-period"]').forEach(radio => {
      radio.addEventListener('change', () => {
        currentPeriod = parseInt(radio.value);
        refreshCharts();
      });
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  async function init() {
    createMainChart();
    createLocalMiniChart();
    await refreshLocalPanel();
    await refreshCharts();
    bindButtons();
  }

  // –ó–∞–ø—É—Å–∫
  init();
})();
</script>
{% endblock %}
